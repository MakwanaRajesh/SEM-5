using System.Data.SqlClient;
using System.Data;
using Microsoft.AspNetCore.Mvc;
using QuizManagement.Models;

namespace QuizManagement.Controllers
{
    
    public class LoginController : Controller
    {
        public IActionResult LogIn()
        {
            return View();                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
        }
        
            private IConfiguration Configuration;

            public LoginController(IConfiguration _configuration)
            {
                Configuration = _configuration;
            }

            //public IActionResult Index()
            //{
            //    return View("LogIn");
            //}

            [HttpPost]
            public IActionResult Login(UserModel userLoginModel)
            {
                string ErrorMsg = string.Empty;

            if (string.IsNullOrEmpty(userLoginModel.UserName))
                ModelState.AddModelError("UserName", "User Name is Required");

            if (string.IsNullOrEmpty(userLoginModel.Password))
                ModelState.AddModelError("Password", "Password is Required");


            if (ModelState.IsValid)
                {
                    SqlConnection conn = new SqlConnection(this.Configuration.GetConnectionString("ConnectionString"));
                    conn.Open();

                    SqlCommand objCmd = conn.CreateCommand();

                    objCmd.CommandType = System.Data.CommandType.StoredProcedure;
                    objCmd.CommandText = "PR_MST_User_Login";
                    objCmd.Parameters.AddWithValue("@UserName", userLoginModel.UserName);
                    objCmd.Parameters.AddWithValue("@Password", userLoginModel.Password);

                    SqlDataReader objSDR = objCmd.ExecuteReader();

                    DataTable dtLogin = new DataTable();

                    // Check if Data Reader has Rows or not
                    // if row(s) does not exists that means either username or password or both are invalid.
                    if (!objSDR.HasRows)
                    {
                        TempData["ErrorMessage"] = "Invalid User Name or Password";
                        return RedirectToAction("LogIn", "Login");
                    }
                    else
                    {
                        dtLogin.Load(objSDR);

                        //Load the retrived data to session through HttpContext.
                        foreach (DataRow dr in dtLogin.Rows)
                        {
                            HttpContext.Session.SetString("UserID", dr["UserID"].ToString());
                            HttpContext.Session.SetString("UserName", dr["UserName"].ToString());
                            HttpContext.Session.SetString("Mobile", dr["Mobile"].ToString());
                            HttpContext.Session.SetString("Email", dr["Email"].ToString());
                        }

                        return RedirectToAction("Index", "Home");
                    }
                }
                else
                {
                    TempData["ErrorMessage"] = ErrorMsg;
                    return RedirectToAction("LogIn", "Login");
                }
            }

            [HttpPost]
            public IActionResult Logout()
            {
                HttpContext.Session.Clear();
                return RedirectToAction("Index");
            }
        }
    }
